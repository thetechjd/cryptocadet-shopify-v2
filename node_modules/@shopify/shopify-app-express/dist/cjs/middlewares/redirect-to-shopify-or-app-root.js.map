{"version":3,"file":"redirect-to-shopify-or-app-root.js","sources":["../../../../src/middlewares/redirect-to-shopify-or-app-root.ts"],"sourcesContent":["import {Request, Response} from 'express';\n\nimport {ApiAndConfigParams} from '../types';\n\nimport {RedirectToShopifyOrAppRootMiddleware} from './types';\n\nexport function redirectToShopifyOrAppRoot({\n  api,\n  config,\n}: ApiAndConfigParams): RedirectToShopifyOrAppRootMiddleware {\n  return function () {\n    return async function (req: Request, res: Response) {\n      if (res.headersSent) {\n        config.logger.info(\n          'Response headers have already been sent, skipping redirection to host',\n          {shop: res.locals.shopify?.session?.shop},\n        );\n\n        return;\n      }\n\n      const host = api.utils.sanitizeHost(req.query.host as string)!;\n      const redirectUrl = api.config.isEmbeddedApp\n        ? await api.auth.getEmbeddedAppUrl({\n            rawRequest: req,\n            rawResponse: res,\n          })\n        : `/?shop=${res.locals.shopify.session.shop}&host=${encodeURIComponent(\n            host,\n          )}`;\n\n      config.logger.debug(`Redirecting to host at ${redirectUrl}`, {\n        shop: res.locals.shopify.session.shop,\n      });\n\n      res.redirect(redirectUrl);\n    };\n  };\n}\n"],"names":[],"mappings":";;SAMgB,0BAA0B,CAAC,EACzC,GAAG,EACH,MAAM,GACa,EAAA;IACnB,OAAO,YAAA;AACL,QAAA,OAAO,gBAAgB,GAAY,EAAE,GAAa,EAAA;AAChD,YAAA,IAAI,GAAG,CAAC,WAAW,EAAE;gBACnB,MAAM,CAAC,MAAM,CAAC,IAAI,CAChB,uEAAuE,EACvE,EAAC,IAAI,EAAE,GAAG,CAAC,MAAM,CAAC,OAAO,EAAE,OAAO,EAAE,IAAI,EAAC,CAC1C;gBAED;YACF;AAEA,YAAA,MAAM,IAAI,GAAG,GAAG,CAAC,KAAK,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,IAAc,CAAE;AAC9D,YAAA,MAAM,WAAW,GAAG,GAAG,CAAC,MAAM,CAAC;AAC7B,kBAAE,MAAM,GAAG,CAAC,IAAI,CAAC,iBAAiB,CAAC;AAC/B,oBAAA,UAAU,EAAE,GAAG;AACf,oBAAA,WAAW,EAAE,GAAG;iBACjB;AACH,kBAAE,CAAA,OAAA,EAAU,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAA,MAAA,EAAS,kBAAkB,CAClE,IAAI,CACL,EAAE;YAEP,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAA,uBAAA,EAA0B,WAAW,EAAE,EAAE;gBAC3D,IAAI,EAAE,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI;AACtC,aAAA,CAAC;AAEF,YAAA,GAAG,CAAC,QAAQ,CAAC,WAAW,CAAC;AAC3B,QAAA,CAAC;AACH,IAAA,CAAC;AACH;;;;"}